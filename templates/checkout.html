{% extends "base.html" %}
{% block title %}Checkout â€“ Omen Astrology{% endblock %}
{% block content %}
<section class="section checkout">
  <div class="wrap text-col">
    <h1 class="h-title">Order Review</h1>
    <ul>
      {% for item in items %}
        <li>{{ item.name }} ({{ item.reading_mode|upper }}): &euro;{{ '%.2f'|format(item.price) }}</li>
      {% endfor %}
    </ul>
    <p><b>Total: &euro;{{ total }}</b></p>
    <div id="paypal-buttons"></div>
  </div>
</section>
{% endblock %}
{% block scripts %}
<script src="https://www.paypal.com/sdk/js?client-id={{ paypal_client_id }}&currency=EUR"></script>
<script>
    paypal.Buttons({
        createOrder: function() {
            const orderId = "{{ order_id }}";
            const reading = "{{ items[0].reading_type }}";
            const mode = "{{ items[0].reading_mode }}";

            return fetch(`/api/paypal/orders?order_id=${orderId}&reading=${reading}&mode=${mode}`, {
                method: "POST"
            })
            .then(res => res.json())
            .then(data => data.id);
        },
        onApprove: function (data) {
          const orderId = "{{ order_id }}";
          const reading = "{{ items[0].reading_type }}";
          const mode = "{{ items[0].reading_mode }}";

          return fetch(`/api/paypal/orders/${data.orderID}/capture?order_id=${orderId}&reading=${reading}&mode=${mode}`, {
            method: "POST"
          })
          .then(async (r) => {
            if (!r.ok) {
              const t = await r.text().catch(() => "");
              alert("Server error capturing payment.\n" + t);
              return;
            }
            const res = await r.json().catch(() => ({}));
            if (res.redirect) window.location = res.redirect;
            else window.location = `/thankyou?status=paid&order_id=${orderId}`;
          })
          .catch(() => alert("Network error while capturing payment."));
        },
        onError: function(err) {
            console.error(err);
            window.location.href = "/thankyou?status=failed";
        }
    }).render('#paypal-buttons');
</script>
{% endblock %}
